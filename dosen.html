<!-- ===================================== -->
<!--              DOSEN.HTML             -->
<!-- ===================================== -->
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Dosen</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div class="container py-4">
    <h2 class="text-center mb-4">ğŸ“‹ Panel Dosen - Absensi QR</h2>
    <div class="text-center mb-4">
      <div id="qrcode"></div>
      <button onclick="generateQRCode()" class="btn btn-success mt-3">ğŸ” Generate QR</button>
    </div>
    <h4 class="mb-3">ğŸ“„ Daftar Mahasiswa Hadir Hari Ini</h4>
    <div class="table-responsive">
      <table class="table table-bordered" id="tabel-absen">
        <thead>
          <tr>
            <th>No</th>
            <th>NIM</th>
            <th>Nama</th>
            <th>Tanggal</th>
            <th>Jam</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <button class="btn btn-warning mt-3" onclick="exportToExcel()">ğŸ“¥ Export ke Excel</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCCJwC685IGikpDCFnc6XPLrodGi4TqkOU",
      authDomain: "absensi-qr-42757.firebaseapp.com",
      databaseURL: "https://absensi-qr-42757-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "absensi-qr-42757",
      storageBucket: "absensi-qr-42757.appspot.com",
      messagingSenderId: "914063064915",
      appId: "1:914063064915:web:cbfc9f253fe38f1370eba6"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const qrData = new Date().toISOString().split("T")[0];

    function generateQRCode() {
      document.getElementById("qrcode").innerHTML = "";
      new QRCode("qrcode", {
        text: qrData,
        width: 200,
        height: 200
      });
    }

    function tampilkanAbsensi() {
      const ref = database.ref("absensi/" + qrData);
      const tbody = document.querySelector("#tabel-absen tbody");
      tbody.innerHTML = "";

      ref.on("value", snapshot => {
        const data = snapshot.val();
        let index = 1;
        if (data) {
          Object.values(data).forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${index++}</td>
              <td>${item.nim || '-'}</td>
              <td>${item.nama}</td>
              <td>${item.tanggal}</td>
              <td>${item.jam}</td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="5">Belum ada absensi hari ini.</td>`;
          tbody.appendChild(tr);
        }
      });
    }

    function exportToExcel() {
      const table = document.getElementById("tabel-absen");
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(table);
      XLSX.utils.book_append_sheet(wb, ws, "Absensi");
      XLSX.writeFile(wb, "data_absensi.xlsx");
    }

    document.addEventListener("DOMContentLoaded", () => {
      generateQRCode();
      tampilkanAbsensi();
    });
  </script>
</body>
</html>
